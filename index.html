<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Texto Rico</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f9fafb;
            height: 100vh;
            overflow: hidden;
        }
        
        .container { display: flex; height: 100vh; }
        
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-primary:hover { background: #2563eb; }
        
        .header-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .btn-backup {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.875rem;
        }
        
        .btn-backup:hover { background: #059669; }
        
        .btn-restore {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.875rem;
        }
        
        .btn-restore:hover { background: #d97706; }
        
        .search-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            outline: none;
        }
        
        .notes-list { flex: 1; overflow-y: auto; }
        
        .note-item {
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .note-item:hover { background: #f9fafb; }
        .note-item.active { background: #eff6ff; border-left: 4px solid #3b82f6; }
        
        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        
        .note-title {
            font-weight: 600;
            color: #1f2937;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .note-actions {
            display: flex;
            gap: 0.25rem;
            margin-left: 0.5rem;
        }
        
        .btn-icon {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: color 0.2s;
        }
        
        .btn-icon:hover { color: #3b82f6; }
        .btn-icon.delete:hover { color: #ef4444; }
        
        .note-content {
            color: #6b7280;
            font-size: 0.875rem;
            line-height: 1.25;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .note-date {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.5rem;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .content-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .content-title { flex: 1; }
        
        .content-title h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }
        
        .content-title input {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
        }
        
        .content-date {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        .content-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-secondary:hover { background: #4b5563; }
        
        .btn-success {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-success:hover { background: #059669; }
        
        .toolbar {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.5rem 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .toolbar-group {
            display: flex;
            gap: 0.25rem;
            padding-right: 0.5rem;
            border-right: 1px solid #e5e7eb;
        }
        
        .toolbar-group:last-child { border-right: none; }
        
        .toolbar-btn {
            background: none;
            border: 1px solid #d1d5db;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .toolbar-btn:hover { background: #f3f4f6; }
        .toolbar-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        
        .toolbar-select {
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            padding: 0.25rem;
            font-size: 0.875rem;
            outline: none;
        }
        
        .content-area {
            flex: 1;
            padding: 1rem;
            background: white;
        }
        
        .rich-editor {
            width: 100%;
            height: 100%;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            outline: none;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.5;
            overflow-y: auto;
        }
        
        .rich-editor:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        
        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #6b7280;
        }
        
        .hidden { display: none; }
        
        .backup-info {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }
        
        .backup-info strong { color: #92400e; }
        
        /* Estilos para o conteúdo do editor */
        .rich-editor h1 { font-size: 2rem; margin: 1rem 0; }
        .rich-editor h2 { font-size: 1.5rem; margin: 0.8rem 0; }
        .rich-editor h3 { font-size: 1.25rem; margin: 0.6rem 0; }
        .rich-editor p { margin: 0; line-height: 1.5; }
        .rich-editor br { line-height: 1.5; }
        .rich-editor ul, .rich-editor ol { margin: 0.5rem 0; padding-left: 1.2rem; }
        .rich-editor li { margin: 0.2rem 0; }
        .rich-editor ul ul, .rich-editor ol ol, .rich-editor ul ol, .rich-editor ol ul { margin: 0; }
        .rich-editor blockquote { 
            border-left: 4px solid #d1d5db; 
            padding-left: 1rem; 
            margin: 1rem 0; 
            color: #6b7280; 
        }

        /* Input file oculto */
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="header-top">
                    <h1 class="title">Minhas Notas</h1>
                    <button class="btn-primary" onclick="createNote()">+</button>
                </div>
                
                <div class="backup-info">
                    <strong>💡 Dica:</strong> Faça backup regularmente das suas notas para não perdê-las!
                </div>
                
                <div class="header-actions">
                    <button class="btn-backup" onclick="exportNotes()">📦 Backup</button>
                    <button class="btn-restore" onclick="importNotes()">📥 Restaurar</button>
                </div>
                
                <input type="text" placeholder="Pesquisar..." class="search-input" oninput="searchNotes(this.value)">
            </div>
            <div class="notes-list" id="notesList"></div>
        </div>

        <div class="main-content">
            <div id="contentHeader" class="content-header hidden">
                <div class="content-title">
                    <input type="text" id="editTitle" class="hidden">
                    <h2 id="displayTitle"></h2>
                    <p class="content-date" id="contentDate"></p>
                </div>
                <div class="content-actions">
                    <button id="editBtn" class="btn-primary" onclick="editNote()">Editar</button>
                    <button id="saveBtn" class="btn-success hidden" onclick="saveNote()">Salvar</button>
                    <button id="cancelBtn" class="btn-secondary hidden" onclick="cancelEdit()">Cancelar</button>
                </div>
            </div>
            
            <div id="toolbar" class="toolbar hidden">
                <div class="toolbar-group">
                    <select class="toolbar-select" onchange="formatText('formatBlock', this.value)">
                        <option value="div">Parágrafo</option>
                        <option value="h1">Título 1</option>
                        <option value="h2">Título 2</option>
                        <option value="h3">Título 3</option>
                    </select>
                </div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" onclick="formatText('bold')" title="Negrito"><b>N</b></button>
                    <button class="toolbar-btn" onclick="formatText('italic')" title="Itálico"><i>I</i></button>
                    <button class="toolbar-btn" onclick="formatText('underline')" title="Sublinhado"><u>S</u></button>
                </div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" onclick="formatText('justifyLeft')" title="Alinhar à esquerda">←</button>
                    <button class="toolbar-btn" onclick="formatText('justifyCenter')" title="Centralizar">↔</button>
                    <button class="toolbar-btn" onclick="formatText('justifyRight')" title="Alinhar à direita">→</button>
                </div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" onclick="formatText('insertUnorderedList')" title="Lista">• Lista</button>
                    <button class="toolbar-btn" onclick="formatText('insertOrderedList')" title="Lista numerada">1. Lista</button>
                    <button class="toolbar-btn" onclick="formatText('outdent')" title="Diminuir recuo">⬅</button>
                    <button class="toolbar-btn" onclick="formatText('indent')" title="Aumentar recuo">➡</button>
                </div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" onclick="formatText('createLink')" title="Link">🔗</button>
                    <button class="toolbar-btn" onclick="formatText('unlink')" title="Remover link">⛓️‍💥</button>
                </div>
            </div>
            
            <div class="content-area">
                <div id="emptyState" class="empty-state">
                    <div>
                        <h3>Selecione uma nota</h3>
                        <p>Escolha uma nota da lista ou crie uma nova</p>
                    </div>
                </div>
                
                <div id="contentEditor" class="rich-editor hidden" contenteditable="false"></div>
                <div id="contentDisplay" class="rich-editor hidden"></div>
            </div>
        </div>
    </div>

    <!-- Input file oculto para importar -->
    <input type="file" id="fileInput" accept=".json" onchange="handleFileImport(event)">

    <script>
        let notes = JSON.parse(localStorage.getItem('rich-notes') || '[]');
        let currentNote = null;
        let isEditing = false;
        
        function saveNotes() {
            localStorage.setItem('rich-notes', JSON.stringify(notes));
        }
        
        function exportNotes() {
            if (notes.length === 0) {
                alert('Não há notas para exportar!');
                return;
            }
            
            const dataStr = JSON.stringify(notes, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `minhas-notas-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`Backup criado com ${notes.length} notas! Salve o arquivo em local seguro.`);
        }
        
        function importNotes() {
            document.getElementById('fileInput').click();
        }
        
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedNotes = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedNotes)) {
                        throw new Error('Formato inválido');
                    }
                    
                    const action = confirm(
                        `Arquivo contém ${importedNotes.length} notas.\n\n` +
                        'Clique OK para SUBSTITUIR todas as notas atuais\n' +
                        'Clique Cancelar para ADICIONAR às notas existentes'
                    );
                    
                    if (action) {
                        // Substituir
                        notes = importedNotes;
                    } else {
                        // Adicionar (evitar IDs duplicados)
                        const maxId = Math.max(...notes.map(n => n.id), 0);
                        const adjustedNotes = importedNotes.map((note, index) => ({
                            ...note,
                            id: maxId + index + 1
                        }));
                        notes = [...adjustedNotes, ...notes];
                    }
                    
                    saveNotes();
                    renderNotes();
                    
                    // Limpar seleção atual se necessário
                    if (currentNote && !notes.find(n => n.id === currentNote.id)) {
                        currentNote = null;
                        document.getElementById('emptyState').classList.remove('hidden');
                        document.getElementById('contentHeader').classList.add('hidden');
                        document.getElementById('contentDisplay').classList.add('hidden');
                        cancelEdit();
                    }
                    
                    alert('Notas importadas com sucesso!');
                    
                } catch (error) {
                    alert('Erro ao importar arquivo. Verifique se é um backup válido.');
                }
            };
            reader.readAsText(file);
            
            // Limpar input
            event.target.value = '';
        }
        
        function createNote() {
            if (isEditing && !confirm('Deseja salvar as alterações?')) return;
            
            const note = {
                id: Date.now(),
                title: 'Nova Nota',
                content: '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            notes.unshift(note);
            saveNotes();
            renderNotes();
            selectNote(note);
            editNote();
        }
        
        function renderNotes(filtered = null) {
            const list = document.getElementById('notesList');
            const toRender = filtered || notes;
            
            if (toRender.length === 0) {
                list.innerHTML = '<div class="empty-state"><p>Nenhuma nota encontrada</p></div>';
                return;
            }
            
            list.innerHTML = toRender.map(note => `
                <div class="note-item ${currentNote?.id === note.id ? 'active' : ''}" onclick="selectNote(${JSON.stringify(note).replace(/"/g, '&quot;')})">
                    <div class="note-header">
                        <div class="note-title">${note.title}</div>
                        <div class="note-actions">
                            <button class="btn-icon" onclick="event.stopPropagation(); editNoteFromList(${note.id})">✏️</button>
                            <button class="btn-icon delete" onclick="event.stopPropagation(); deleteNote(${note.id})">🗑️</button>
                        </div>
                    </div>
                    <p class="note-content">${note.content.replace(/<[^>]*>/g, '').substring(0, 100) || 'Sem conteúdo'}</p>
                    <div class="note-date">${formatDate(note.updatedAt)}</div>
                </div>
            `).join('');
        }
        
        function selectNote(note) {
            if (isEditing && !confirm('Deseja salvar as alterações?')) return;
            
            currentNote = note;
            showContent();
        }
        
        function showContent() {
            if (!currentNote) return;
            
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('contentHeader').classList.remove('hidden');
            document.getElementById('contentDisplay').classList.remove('hidden');
            
            document.getElementById('displayTitle').textContent = currentNote.title;
            document.getElementById('contentDate').textContent = `Modificado: ${formatDate(currentNote.updatedAt)}`;
            document.getElementById('contentDisplay').innerHTML = currentNote.content || '<p style="color: #9ca3af; font-style: italic;">Esta nota está vazia</p>';
            
            renderNotes();
        }
        
        function editNote() {
            if (!currentNote) return;
            
            isEditing = true;
            document.getElementById('editTitle').value = currentNote.title;
            document.getElementById('contentEditor').innerHTML = currentNote.content;
            
            // Mostrar elementos de edição
            document.getElementById('editTitle').classList.remove('hidden');
            document.getElementById('displayTitle').classList.add('hidden');
            document.getElementById('contentEditor').classList.remove('hidden');
            document.getElementById('contentEditor').contentEditable = true;
            document.getElementById('contentDisplay').classList.add('hidden');
            document.getElementById('toolbar').classList.remove('hidden');
            
            document.getElementById('editBtn').classList.add('hidden');
            document.getElementById('saveBtn').classList.remove('hidden');
            document.getElementById('cancelBtn').classList.remove('hidden');
            
            document.getElementById('contentEditor').focus();
        }
        
        function editNoteFromList(id) {
            const note = notes.find(n => n.id === id);
            if (note) {
                selectNote(note);
                editNote();
            }
        }
        
        function saveNote() {
            if (!currentNote) return;
            
            const title = document.getElementById('editTitle').value;
            const content = document.getElementById('contentEditor').innerHTML;
            
            const index = notes.findIndex(n => n.id === currentNote.id);
            if (index !== -1) {
                notes[index] = {
                    ...currentNote,
                    title: title,
                    content: content,
                    updatedAt: new Date().toISOString()
                };
                currentNote = notes[index];
                saveNotes();
                renderNotes();
                cancelEdit();
                showContent();
            }
        }
        
        function cancelEdit() {
            isEditing = false;
            
            document.getElementById('editTitle').classList.add('hidden');
            document.getElementById('displayTitle').classList.remove('hidden');
            document.getElementById('contentEditor').classList.add('hidden');
            document.getElementById('contentEditor').contentEditable = false;
            document.getElementById('contentDisplay').classList.remove('hidden');
            document.getElementById('toolbar').classList.add('hidden');
            
            document.getElementById('editBtn').classList.remove('hidden');
            document.getElementById('saveBtn').classList.add('hidden');
            document.getElementById('cancelBtn').classList.add('hidden');
        }
        
        function deleteNote(id) {
            if (!confirm('Excluir esta nota?')) return;
            
            notes = notes.filter(n => n.id !== id);
            saveNotes();
            renderNotes();
            
            if (currentNote?.id === id) {
                currentNote = null;
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('contentHeader').classList.add('hidden');
                document.getElementById('contentDisplay').classList.add('hidden');
                cancelEdit();
            }
        }
        
        function searchNotes(term) {
            if (!term.trim()) {
                renderNotes();
                return;
            }
            
            const filtered = notes.filter(note =>
                note.title.toLowerCase().includes(term.toLowerCase()) ||
                note.content.toLowerCase().includes(term.toLowerCase())
            );
            
            renderNotes(filtered);
        }
        
        function formatText(command, value = null) {
            if (command === 'createLink') {
                const url = prompt('Digite a URL:');
                if (url) document.execCommand(command, false, url);
            } else if (command === 'insertUnorderedList' || command === 'insertOrderedList') {
                const selection = window.getSelection();
                
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    
                    if (!range.collapsed) {
                        const selectedText = range.toString();
                        const listType = command === 'insertUnorderedList' ? 'ul' : 'ol';
                        const listHTML = `<${listType}><li>${selectedText}</li></${listType}>`;
                        
                        range.deleteContents();
                        const temp = document.createElement('div');
                        temp.innerHTML = listHTML;
                        const listNode = temp.firstChild;
                        range.insertNode(listNode);
                        
                        const newRange = document.createRange();
                        newRange.selectNodeContents(listNode.firstChild);
                        newRange.collapse(false);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                    } else {
                        document.execCommand('outdent');
                        document.execCommand('outdent');
                        document.execCommand('outdent');
                        
                        const listType = command === 'insertUnorderedList' ? 'ul' : 'ol';
                        const listHTML = `<${listType}><li></li></${listType}>`;
                        document.execCommand('insertHTML', false, listHTML);
                    }
                }
            } else {
                document.execCommand(command, false, value);
            }
            document.getElementById('contentEditor').focus();
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }
        
        // Inicialização
        renderNotes();
        
        // Atualizar botões da toolbar baseado na seleção
        document.getElementById('contentEditor').addEventListener('keyup', updateToolbar);
        document.getElementById('contentEditor').addEventListener('mouseup', updateToolbar);
        document.getElementById('contentEditor').addEventListener('keydown', handleKeyDown);
        
        function updateToolbar() {
            const commands = ['bold', 'italic', 'underline'];
            commands.forEach(cmd => {
                const btn = document.querySelector(`[onclick*="${cmd}"]`);
                if (btn) {
                    btn.classList.toggle('active', document.queryCommandState(cmd));
                }
            });
        }
        
        function handleKeyDown(e) {
            if (e.key === 'Enter') {
                const selection = window.getSelection();
                const node = selection.anchorNode;
                if (node && node.parentElement) {
                    const li = node.parentElement.closest('li');
                    if (li && li.textContent.trim() === '') {
                        e.preventDefault();
                        document.execCommand('outdent');
                        return;
                    }
                }
            }
        }
    </script>
</body>
</html>
